
/**
 * Created by vinay.singh on 3/4/2017.
 */
var orgData = {
    "children": [
        {
            "children": [
                {"name": "DEPARTMENT OF Really Really Really Long Names "},
                {"name": "DEPARTMENT OF SCOTCH TAPE"},
                {"name": "DEPARTMENT OF STEREOS"},
                {
                    "children": [
                        {"name": "Dogs"},
                        {"name": "Cats"},
                        {"name": "Birds"}
                    ],
                    "name": "DEPARTMENT OF ANIMALS"
                },

                {

                    "name": "DEPARTMENT OF PILLOWS"
                },
                {
                    "children": [
                        {
                            "children": [
                                {"name": "Mens Wear"},
                                {"name": "Womens Wear"},
                                {"name": "Childrens Wear"}
                            ],
                            "name": "Barneys New York"
                        },
                        {
                            "children": [
                                {"name": "Mens Wear"},
                                {"name": "Womens Wear"},
                                {"name": "Childrens Wear"}
                            ],
                            "name": "Boscov's"
                        },
                        {
                            "children": [
                                {"name": "Mens Wear"},
                                {"name": "Womens Wear"},
                                {"name": "Childrens Wear"}
                            ],
                            "name": "Bloomingdale's"
                        },
                        {
                            "children": [
                                {"name": "Mens Wear"},
                                {"name": "Womens Wear"},
                                {"name": "Childrens Wear"}
                            ],
                            "name": "Macy's"
                        },
                        {
                            "children": [
                                {"name": "Mens Wear"},
                                {"name": "Womens Wear"},
                                {"name": "Childrens Wear"},
                                {
                                    "children": [
                                        {
                                            "children": [
                                                {"name": "Body Pillow"},
                                                {"name": "Contour Pillow"},
                                                {"name": "Down Pillow"},
                                                {"name": "Polyester Pillow"}
                                            ],
                                            "name": "Pillows"
                                        },
                                        {"name": "Lamps"},
                                        {"name": "Tables"},
                                        {"name": "Couches"},
                                        {"name": "Lamps"},
                                    ],
                                    "name": "Bedding and Home Decor"
                                },
                                {
                                    "children": [
                                        {"name": "High-Top Shoes"},
                                        {"name": "Low-Top Shoes"},
                                        {"name": "Boots"},
                                        {"name": "Sneakers"}
                                    ],
                                    "name": "Shoes, Sneakers, Boots and Booties"
                                },
                            ],
                            "name": "JCPenney"
                        },
                    ],
                    "name": "DEPARTMENT STORES"
                }
            ],
            "name": "Departments"
        },
        {
            "children": [
                {"name": "Alabama"},
                {"name": "Alaska"},
                {"name": "Arizona"},
                {"name": "Arkansas"},
                {
                    "children": [
                        {"name": "California EMA"},
                        {"name": "Los Angeles Police Department"}
                    ],
                    "name": "California"
                },
                {"name": "Colorado"},
                {"name": "Connecticut"},
                {"name": "Delaware"},
                {"name": "District of Columbia"},
                {
                    "children": [{"name": "Florida Department of Law Enforcement"}],
                    "name": "Florida"
                },
                {"name": "Georgia"},
                {"name": "Hawaii"},
                {"name": "Idaho"},
                {"name": "Illinois"},
                {
                    "children": [
                        {"name": "Indianapolis Department of Public Safety"},
                        {"name": "Putnam County"}
                    ],
                    "name": "Indiana"
                },
                {"name": "Iowa"},
                {"name": "Kansas"},
                {"name": "Kentucky"},
                {
                    "children": [{"name": "New Orleans UASI"}],
                    "name": "Louisiana"
                },
                {"name": "Maine"},
                {"name": "Maryland"},
                {"name": "Massachusetts"},
                {"name": "Michigan"},
                {
                    "children": [{"name": "Minneapolis"}],
                    "name": "Minnesota"
                },
                {"name": "Mississippi"},
                {"name": "Missouri"},
                {"name": "Montana"},
                {"name": "Nebraska"},
                {"name": "Nevada"},
                {"name": "New Hampshire"},
                {"name": "New Jersey"},
                {"name": "New Mexico"},
                {"name": "New York"},
                {"name": "North Carolina"},
                {"name": "North Dakota"},
                {"name": "Ohio"},
                {"name": "Oklahoma"},
                {"name": "Oregon"},
                {
                    "children": [
                        {"name": "Chester County"},
                        {"name": "City of Philadelphia"},
                        {"name": "Pittsburgh"}
                    ],
                    "name": "Pennsylvania"
                },
                {"name": "Rhode Island"},
                {"name": "South Carolina"},
                {"name": "South Dakota"},
                {"name": "Tennessee"},
                {
                    "children": [{"name": "Houston"}],
                    "name": "Texas"
                },
                {"name": "Utah"},
                {"name": "Vermont"},
                {"name": "Virginia"},
                {
                    "children": [{"name": "Seattle"}],
                    "name": "Washington"
                },
                {"name": "West Virginia"},
                {"name": "Wisconsin"},
                {"name": "Wyoming"}
            ],
            "name": "State/Local"
        },
        {
            "children": [
                {"name": "California Institute of Technology"},
                {"name": "Stanford University"},
                {"name": "Massachusetts Institute of Technology"},
                {"name": "Harvard University"},
                {"name": "Princeton University"},
                {"name": "University of California, Berkeley"},
                {"name": "University of Chicago"},
                {"name": "Yale University"},
                {"name": "University of Pennsylvania"},
                {"name": "University of California, Los Angeles"},
                {"name": "Columbia University"},
                {"name": "Johns Hopkins University"},
                {"name": "Duke University"},
                {"name": "Cornell University"},
                {"name": "Northwestern University"},
                {"name": "University of Michigan"},
                {"name": "Carnegie Mellon University"},
                {"name": "University of Washington"},
                {"name": "New York University"},
                {"name": "Georgia Institute of Technology"},
                {"name": "University of Illinois at Urbana-Champaign"},
                {"name": "University of California, San Diego"},
                {"name": "University of Wisconsin-Madison"},
                {"name": "University of California, Santa Barbara"},
                {"name": "University of Texas at Austin"},
                {"name": "Brown University"},
                {"name": "University of California, Davis"},
                {"name": "University of Minnesota"},
                {"name": "University of North Carolina at Chapel Hill"},
                {"name": "Washington University in St Louis"},
                {"name": "University of Southern California"},
                {"name": "Boston University"},
                {"name": "University of Maryland, College Park"},
                {"name": "Pennsylvania State University"},
                {"name": "Purdue University"},
                {"name": "Ohio State University"},
                {"name": "University of Pittsburgh"},
                {"name": "Dartmouth College"},
                {"name": "Emory University"},
                {"name": "Rice University"},
                {"name": "University of California, Irvine"},
                {"name": "Michigan State University"},
                {"name": "Georgetown University"},
                {"name": "Vanderbilt University"},
                {"name": "University of Colorado Boulder"},
                {"name": "University of Virginia"},
                {"name": "Case Western Reserve University"},
                {"name": "Arizona State University"},
                {"name": "University of Florida"},
                {"name": "Tufts University"},
                {"name": "Rutgers, the State University of New Jersey"},
                {"name": "University of Notre Dame"},
                {"name": "University of California, Santa Cruz"},
                {"name": "Indiana University"},
                {"name": "University of Rochester"},
                {"name": "University of Arizona"},
                {"name": "University of California, Riverside"},
                {"name": "University of Massachusetts"},
                {"name": "Texas A&M University"},
                {"name": "Northeastern University"},
                {"name": "University of Miami"},
                {"name": "Brandeis University"},
                {"name": "University of Illinois at Chicago"},
                {"name": "Boston College"},
                {"name": "Florida State University"},
                {"name": "George Washington University"},
                {"name": "North Carolina State University"},
                {"name": "Stony Brook University"},
                {"name": "University of Cincinnati"},
                {"name": "University of Delaware"},
                {"name": "University of Hawai’i at Mānoa"},
                {"name": "University of Iowa"},
                {"name": "University of South Florida"},
                {"name": "University of Texas at Dallas"},
                {"name": "University of Utah"},
                {"name": "Wake Forest University"},
                {"name": "Colorado School of Mines"},
                {"name": "Oregon Health and Science University"},
                {"name": "Rensselaer Polytechnic Institute"},
                {"name": "Rush University"},
                {"name": "Syracuse University"},
                {"name": "University at Buffalo"},
                {"name": "University of Tennessee, Knoxville"},
                {"name": "Virginia Polytechnic Institute and State University"},
                {"name": "William & Mary"},
                {"name": "Clark University"},
                {"name": "Colorado State University"},
                {"name": "George Mason University"},
                {"name": "Oregon State University"},
                {"name": "Saint Louis University"},
                {"name": "Temple University"},
                {"name": "University of Alaska Fairbanks"},
                {"name": "University of Connecticut"},
                {"name": "University of Denver"},
                {"name": "University of Georgia"},
                {"name": "University of Nebraska-Lincoln"},
                {"name": "University of Oregon"},
                {"name": "Binghamton University, State University of New York"},
                {"name": "Drexel University"},
                {"name": "Iowa State University"},
                {"name": "Tulane University"},
                {"name": "University of Houston"},
                {"name": "University of Kansas"},
                {"name": "University of Kentucky"},
                {"name": "University of Missouri"},
                {"name": "University of Oklahoma"},
                {"name": "University of Texas at San Antonio"},
                {"name": "Washington State University"},
                {"name": "Wayne State University"},
                {"name": "American University"},
                {"name": "Florida International University"},
                {"name": "Georgia State University"},
                {"name": "Kent State University"},
                {"name": "Lehigh University"},
                {"name": "New Mexico State University"},
                {"name": "Northern Arizona University"},
                {"name": "San Diego State University"},
                {"name": "Stevens Institute of Technology"},
                {"name": "University of Maryland, Baltimore County"},
                {"name": "University of Montana"},
                {"name": "Creighton University"},
                {"name": "Kansas State University"},
                {"name": "Louisiana State University"},
                {"name": "Missouri University of Science and Technology"},
                {"name": "Montana State University"},
                {"name": "New Jersey Institute of Technology"},
                {"name": "Oklahoma State University"},
                {"name": "Old Dominion University"},
                {"name": "State University of New York Albany"},
                {"name": "University of Arkansas"},
                {"name": "University of Nebraska Medical Center"},
                {"name": "University of Texas at Arlington"},
                {"name": "University of Toledo"},
                {"name": "University of Tulsa"},
                {"name": "University of Wisconsin-Milwaukee"},
                {"name": "Auburn University"},
                {"name": "Clemson University"},
                {"name": "Florida Institute of Technology"},
                {"name": "Hofstra University"},
                {"name": "Miami University"},
                {"name": "Oakland University"},
                {"name": "Ohio University"},
                {"name": "Rochester Institute of Technology"},
                {"name": "Texas Tech University"},
                {"name": "University of North Carolina at Greensboro"},
                {"name": "University of Texas at El Paso"},
                {"name": "Embry-Riddle Aeronautical University"},
                {"name": "University of Southern Mississippi"}
            ],
            "name": "University"
        }
    ],
    "name": "root"
};
(function() {
    var margin = {
            top: 20,
            right: 120,
            bottom: 20,
            left: 120
        },
        width = 960 - margin.right - margin.left,
        height = 800 - margin.top - margin.bottom,
        initPlacement = {
            x0: 20,
            y0: 350
        };
    var i = 0,
        duration = 750,
        baseRectW = 60,
        baseRectH = 30,
        rectW = 60,
        rectH = 30;
  

    //each tier's node has the same width that is based on the node that has the longest containing text
    //this JSON is a mapping of {tierLevel: # px displacement}, where the displacement is how much larger a tier's node is compared to the baseRectW
    var tierDisplacementX = {};

    //a running count of the total amount of displayment occurring at a particular tier
    //a JSON mapping of {tierLevel: (sum of tierDisplacementX[0] tp tierDIisplacementX[n])}
    var cumulativeDisplacementX = {};

    // (Attempts to) Calculate the horizontal value for which a child node should be placed
    var determineChildXValue = function(parent, child) {
      if (child.depth > 2) {
        var parentWidth = (baseRectW * (parent.widthRatio || 1));
        return Math.max( (parent.y + parentWidth + 100), child.y);
      } else {
        return child.y;
      }
    };

    var tree = d3.tree().nodeSize([70, 40]);

    //This is used to determine where links start or where links end (i.e. the start position of a link before it starts animating, or the end position of a link after a link is removed from the canvas)
    var diagonal = d3.svg.diagonal()
        .source(function(d, f){
            //this is before the x/y values are flipped
            //determines the x/y location of where the link starts
            return {x: d.source.x, y: (d.source.y + cumulativeDisplacementX[d.d.source.tierLevel])};
        })
        .target(function(d, f){
            //this is before the x/y values are flipped
            //determines the x/y location of where the link ends
            return {x: d.target.x, y: (d.target.y + cumulativeDisplacementX[d.d.source.tierLevel])};
        })
        .projection(function (d,f,g) {
            return [d.y+(baseRectW * (d.widthRatio || 1)), d.x+rectH/2];
        });

    //This is used to determine where links transition to (i.e. the final positions of the links after the transition animation)
    var diagonalTransition = d3.svg.diagonal()
        .source(function(d, f){
            //this is before the x/y values are flipped
            //determines the x/y location of where the link starts
            return {x: d.source.x, y: d.source.y + (baseRectW * (d.source.widthRatio || 1)) + (cumulativeDisplacementX[d.source.tierLevel])};
        })
        .target(function(d, f){
            //this is before the x/y values are flipped
            //determines the x/y location of where the link ends
            return {x: d.target.x, y: (d.target.y + cumulativeDisplacementX[d.target.tierLevel])};
        })
        .projection(function (d,f,g) {
            return [d.y, d.x+rectH/2];
        });


    // Define root, svg and selectedEntity and
    var root = {};
    var selectedEntity = {};


    // helper function to find initial selected value
    var flatten = function (e) {
        var returnArr = [e];
        if (e.children) {
            e.children.forEach(function (c) {
                returnArr = returnArr.concat(flatten(c));
            });
        }
        return returnArr;
    };

    /**
     * Set node metadata
     * @param node
     * @param tier
     */
    var setNodeProps = function(node,tier) {
        var getWordLength = function(word) {
            return (word.match(/[^A-Z]/g)||'').length + ((word.match(/[A-Z]/g)||'').length * 1.1);
        };
        node.tierLevel = tier;
        if (node.children) {
            var childrenMaxLength = Math.max.apply(this, $.map(node.children,function(e){return getWordLength(e.name);}));
            $.each(node.children,function(){
                this.widthRatio = (childrenMaxLength / 10);
                setNodeProps(this,tier+1);
            });
        }
    };

    var collapse = function(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    };

    var update = function(source) {

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function (d) {
            d.y = (d.depth * 180);
        });

        var childrenMaxLength = Math.max.apply(this, $.map(source.children||[],function(e){return e.name.length;}));
        // console._log(source, childrenMaxLength);

        var rectWidth = baseRectW * (childrenMaxLength / 11);
        var rectHeight = baseRectH;



        // Update the nodes…
        var node = svg.selectAll("g.node")
            .data(nodes, function (d) {
                return d.id || (d.id = ++i);
            });

        // Enter any new nodes at the parent's previous position.
        // Tree defaults to vertical so switch x and y to make it horizontal
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) {
                //When a node is added to the tree, compute and store the amount of potential displacement on the x-axis
                if (typeof tierDisplacementX[d.tierLevel] === 'undefined'){
                    //compute the displacement that the current tier will cause
                    if (d.tierLevel === 0){
                        tierDisplacementX[d.tierLevel] = 0;
                    } else if (d.tierLevel === 1){
                        tierDisplacementX[d.tierLevel] = 0 + (d.widthRatio * baseRectW - baseRectW);
                    } else {
                        tierDisplacementX[d.tierLevel] = (d.widthRatio * baseRectW - baseRectW);
                    }

                    //compute the total amount of displacement ocurring up to (but excluding) the current tier
                    var totalDisplacement = 0;
                    for (var i = d.tierLevel - 1; i > 0; i--){
                        totalDisplacement += tierDisplacementX[i];
                    }
                    cumulativeDisplacementX[d.tierLevel] = totalDisplacement;
                }

                return "translate(" + (source.y0 + (cumulativeDisplacementX[d.tierLevel] || 0)) + "," + source.x0 + ")";
                // return "translate(" + (parseInt(source.x0)+100) + "," + source.y0 + ")";
            })
            .on("click", click);


        nodeEnter.append("rect")
            .attr("width", rectWidth)
            .attr("height", rectHeight)
            .attr("stroke", "black")
            .attr("stroke-width", 1)
            .style("fill", function (d) {
                return d._children ? "lightsteelblue" : "#fff";
            });

        nodeEnter.append("text")
            .attr("x", function(d){ return (baseRectW * (d.widthRatio || 1)) / 2; })
            // .attr("x", rectWidth / 2)
            .attr("y", rectHeight / 2)
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .text(function (d) {
                return d.name;
            });

        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function (d) {
                //transition the node to their final static position
                //you must account for any displacement that has occurred due to previous tiers being larger than expected
                return "translate(" + (d.y + cumulativeDisplacementX[d.tierLevel]) + "," + d.x + ")";              
            });

        nodeUpdate.select("rect")
        // .attr("width", baseRectW)
            .attr("width", function(d){ return baseRectW * (d.widthRatio || 1); })
            .attr("height", rectHeight)
            .attr("stroke", "black")
            .attr("stroke-width", 1)
            .style("fill", function (d) {
                return d._children ? "lightsteelblue" : "#fff";
            });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + (source.y + cumulativeDisplacementX[source.tierLevel]) + "," + source.x + ")";
                // return "translate(" + (parseInt(source.x)+100) + "," + source.y + ")";
            })
            .remove();

        nodeExit.select("rect")
            .attr("width", function(d){ return baseRectW * (d.widthRatio || 1); })
            .attr("height", rectHeight)
            //.attr("width", bbox.getBBox().width)""
            //.attr("height", bbox.getBBox().height)
            .attr("stroke", "black")
            .attr("stroke-width", 1);

        nodeExit.select("text");

        // Update the links…
        var link = svg.selectAll("path.link")
            .data(links, function (d) {
                return d.target.id;
            });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("x", function(d){ return (baseRectW * (d.widthRatio || 1)) / 2; })
            // .attr("x", rectWidth / 2)
            .attr("y", rectHeight / 2)
            .attr("d", function (d) {
                var o = {
                    x: source.x0,
                    y: source.y0
                };
                return diagonal({
                    source: o,
                    target: o,
                    d: d
                });
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", diagonalTransition);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function (d) {
                var o = {
                    x: source.x,
                    y: source.y
                };
                return diagonal({
                    source: o,
                    target: o,
                    d: d
                });
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });

        window.setTimeout(function(){
            setHeight();
        }, (duration+100));
    };

    // Toggle children on click.
    var click = function(d) {
        if (d.children) {   // collapse
            d._children = d.children;
            d.children = null;
        } else {            // expand
            if (d.tierLevel && d.tierLevel==1) {    // only keep one main branch open at a time
                $.each(root.children,function(){
                    if (this !== d) {
                        collapse(this);
                    }
                });
            }
            d.children = d._children;
            d._children = null;
        }
        // select
        if (d.tierLevel > 1) { // restrict to tier 2 or children
            //selectedEntity = d;
            setSelectedDisplay(d);          
        }
        update(d);
    };
  
    function setSelectedDisplay(entity) {     
      $('#selectedEntity').html(
        '<div class="col-md-4 bold">Selected Entity:</div>'+
        '<div class="col-md-8">'+
        '<span title="Selected Entity"><i>'+entity.name+'</i></span>'+
        '</div>'
      ).show();
    }

    var setHeight = function() {
        var newHeight = Math.max(Math.ceil(gElm.node().getBoundingClientRect().height)+300,700);
        var newWidth = Math.max(Math.ceil(gElm.node().getBoundingClientRect().width)+300,900);
        svgElm.attr("height", newHeight).attr("width", newWidth);
        gElm.attr("transform", "translate(" + initPlacement.x0 + "," + newHeight/2 + ")");
        //console._log(newHeight, newHeight/2);
    };

    //Redraw for zoom
    var redraw = function() {
        var sourceEvent = d3.event.sourceEvent;
        //console.log("here", d3.event.translate, d3.event.scale);
        if (true || sourceEvent.ctrlKey && sourceEvent.type == 'wheel') {
            svg.attr("transform",
                "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")");
        } else if (sourceEvent.type == 'mousemove') {
            svg.attr("transform", "translate(" + d3.event.translate + ")");
        }
        // setHeight();
    };

    // Define Data
    $.extend(root, orgData);
    // Update elements with metadata (tierLevel and widthRatio)
    setNodeProps(root,0);
    root.x0 = initPlacement.x0;
    root.y0 = initPlacement.y0;

    root.children.forEach(collapse);
    
    
    // Build Chart
    var svg = d3.select("#orgChart").append("svg").attr("width", 900).attr("height", 700)
    // .call(zm = d3.behavior.zoom().scaleExtent([0.1,3]).on("zoom", redraw))
        .append("g").attr("transform", "translate(" + initPlacement.x0 + "," + initPlacement.y0 + ")");

    var svgElm = d3.select("#orgChart svg"),
        gElm = d3.select("#orgChart svg g");
  
    // Initialize Chart
    update(root);

    //necessary so that zoom knows where to zoom and unzoom from
    // zm.translate([initPlacement.x0, initPlacement.y0]);

    // d3.select("#orgChart").style("min-height", "700px");
})();